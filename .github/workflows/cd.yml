name: CD Pipeline (Local Deploy)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Local Environment
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Stop old container
      run: docker stop my-app & docker rm my-app & exit 0
      shell: cmd
      continue-on-error: true
    
    - name: Build Docker image
      run: docker build -t software-engineering-app:latest .
      shell: cmd
    
    - name: Start PostgreSQL
      run: |
        docker ps -a -f name=postgres | findstr postgres && docker start postgres || docker run -d --name postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=testdb -p 5432:5432 postgres:16-alpine
        exit 0
      shell: cmd
    
    - name: Wait for PostgreSQL
      run: timeout /t 10 /nobreak
      shell: cmd
    
    - name: Deploy application
      run: docker run -d --name my-app -p 8080:8080 -e POSTGRES_DSN="host=host.docker.internal port=5432 user=postgres password=postgres dbname=testdb sslmode=disable" software-engineering-app:latest
      shell: cmd
    
    - name: Wait for app
      run: timeout /t 5 /nobreak
      shell: cmd
    
    - name: Verify deployment
      run: curl -f http://localhost:8080/api/v1/users/
      shell: cmd
      
    - name: Show container logs
      run: docker logs my-app --tail 30
      shell: cmd
      if: always()