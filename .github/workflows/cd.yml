name: CD Pipeline (Local Deploy)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Local Environment
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Stop old container
      run: |
        docker stop my-app 2>`$null
        docker rm my-app 2>`$null
      continue-on-error: true
      shell: powershell
    
    - name: Build Docker image
      run: docker build -t software-engineering-app:latest .
      shell: powershell
    
    - name: Start PostgreSQL if not running
      run: |
        `$container = docker ps -a --filter "name=postgres" --format "{{.Names}}"
        if (`$container -eq "postgres") {
          docker start postgres
        } else {
          docker run -d ``
            --name postgres ``
            -e POSTGRES_PASSWORD=postgres ``
            -e POSTGRES_DB=testdb ``
            -p 5432:5432 ``
            postgres:16-alpine
        }
      shell: powershell
    
    - name: Wait for PostgreSQL
      run: Start-Sleep -Seconds 5
      shell: powershell
    
    - name: Deploy application
      run: |
        docker run -d ``
          --name my-app ``
          -p 8080:8080 ``
          -e POSTGRES_DSN="host=host.docker.internal port=5432 user=postgres password=postgres dbname=testdb sslmode=disable" ``
          software-engineering-app:latest
      shell: powershell
    
    - name: Verify deployment
      run: |
        Start-Sleep -Seconds 3
        Invoke-WebRequest -Uri http://localhost:8080/api/v1/users/ -UseBasicParsing
        Write-Host "âœ… Deployment successful!"
      shell: powershell
      
    - name: Show container logs
      run: docker logs my-app --tail 20
      shell: powershell
      if: always()