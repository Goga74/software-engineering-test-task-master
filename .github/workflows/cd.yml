name: CD Pipeline (Local Deploy)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Local Environment
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Stop old container
      run: |
        docker stop my-app 2>nul || echo Container my-app not running
        docker rm my-app 2>nul || echo Container my-app already removed
      shell: cmd
    
    - name: Build Docker image
      run: docker build -t software-engineering-app:latest .
      shell: cmd
    
    - name: Check and start PostgreSQL
      run: |
        FOR /F %%i IN ('docker ps -aq -f name=postgres') DO SET PGCONTAINER=%%i
        IF DEFINED PGCONTAINER (
          docker start postgres
          echo Started existing postgres
        ) ELSE (
          docker run -d --name postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=testdb -p 5432:5432 postgres:16-alpine
          echo Created new postgres
        )
      shell: cmd
    
    - name: Wait for PostgreSQL
      run: timeout /t 10 /nobreak
      shell: cmd
    
    - name: Deploy application
      run: docker run -d --name my-app -p 8080:8080 -e POSTGRES_DSN="host=host.docker.internal port=5432 user=postgres password=postgres dbname=testdb sslmode=disable" software-engineering-app:latest
      shell: cmd
    
    - name: Wait for app
      run: timeout /t 5 /nobreak
      shell: cmd
    
    - name: Verify deployment
      run: curl -f http://localhost:8080/api/v1/users/ || exit 1
      shell: cmd
      
    - name: Show container logs
      run: docker logs my-app --tail 30
      shell: cmd
      if: always()